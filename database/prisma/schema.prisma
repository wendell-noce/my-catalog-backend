// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum ThemeStore {
  default
  electronics
  pets
  fashion
  beauty
  sports
  food
  books
  home
  kids
  automotive
}

enum Status {
  ACTIVE
  INACTIVE
  ARCHIVED
  OUT_OF_STOCK
}

enum ProductType {
  PHYSICAL
  SERVICE
  DIGITAL
  PORTFOLIO
}

enum PageType {
  BLOG
  ABOUT
  CONTACT
  CUSTOM
  FAQ
  TERMS
  PRIVACY
  RETURNS
}

enum PostStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id              String    @id @default(uuid())
  name            String
  email           String    @unique
  avatar          String?
  password        String
  document        String?   @unique
  cellPhone       String?
  birthDate       DateTime?
  gender          Gender?
  role            UserRole  @default(USER)
  provider        String?   @default("local")
  providerId      String?
  isActive        Boolean   @default(true)
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  phoneVerified   Boolean   @default(false)
  phoneVerifiedAt DateTime?
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  // Relations
  stores              Store[]
  userAddresses       UserAddress[]
  blogPosts           BlogPost[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  emailVerifications  EmailVerification[]
  phoneVerifications  PhoneVerification[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  used      Boolean  @default(false)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// ============================================
// ADDRESSES
// ============================================

model Address {
  id           String   @id @default(uuid())
  street       String
  number       String
  neighborhood String
  city         String
  state        String
  zip_code     String
  country      String
  complement   String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  // Relations
  userAddresses  UserAddress[]
  storeAddresses StoreAddress[]

  @@map("addresses")
}

model UserAddress {
  user_id    String
  address_id String

  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  address Address @relation(fields: [address_id], references: [id], onDelete: Cascade)

  @@id([user_id, address_id])
  @@map("user_addresses")
}

model StoreAddress {
  store_id   String
  address_id String

  store   Store   @relation(fields: [store_id], references: [id], onDelete: Cascade)
  address Address @relation(fields: [address_id], references: [id], onDelete: Cascade)

  @@id([store_id, address_id])
  @@map("store_addresses")
}

// ============================================
// VERIFICATION MODELS
// ============================================

model EmailVerification {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  code      String?
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("email_verifications")
}

model PhoneVerification {
  id        String   @id @default(uuid())
  userId    String
  phone     String
  code      String
  used      Boolean  @default(false)
  attempts  Int      @default(0)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([phone])
  @@index([code])
  @@index([expiresAt])
  @@map("phone_verifications")
}

// ============================================
// STORE
// ============================================

model Store {
  id           String     @id @default(uuid())
  userId       String
  name         String
  slug         String     @unique
  url          String
  description  String?
  address      String?
  city         String?
  state        String?
  postalCode   String?
  country      String?
  email        String?
  logo         String?
  websiteUrl   String?
  whatsappUrl  String?
  instagramUrl String?
  facebookUrl  String?
  phoneNumber  String?
  cellPhone    String?
  themeStore   ThemeStore @default(default)
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  products       Product[]
  categories     Category[]
  inventoryItems InventoryItem[]
  storeAddresses StoreAddress[]
  pages          Page[]
  blogPosts      BlogPost[]
  blogCategories BlogCategory[]
  linktrees      Linktree[]

  @@map("stores")
}

// ============================================
// PRODUCTS & CATALOG
// ============================================

model Product {
  id          String      @id @default(uuid())
  name        String
  description String?
  itemsDetail String?
  productType ProductType @default(PHYSICAL)
  categoryId  String
  slug        String      @unique
  price       Float
  discount    Float?
  storeId     String
  isActive    Boolean     @default(true)
  featured    Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  category Category        @relation(fields: [categoryId], references: [id])
  store    Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  images   ProductImage[]
  reviews  ProductReview[]
  tags     ProductTag[]

  @@index([storeId])
  @@index([categoryId])
  @@index([slug])
  @@index([isActive])
  @@index([featured])
  @@map("products")
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  image     String
  alt       String?
  order     Int?
  isMain    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([productId, order])
  @@map("product_images")
}

model ProductReview {
  id         String   @id @default(uuid())
  productId  String
  userId     String?
  rating     Int
  comment    String?
  userName   String?
  userEmail  String?
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([rating])
  @@map("product_reviews")
}

model ProductTag {
  id        String    @id @default(uuid())
  name      String    @unique
  color     String?
  createdAt DateTime  @default(now())
  products  Product[]

  @@map("product_tags")
}

model Category {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  storeId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isActive    Boolean  @default(true)
  color       String?
  icon        String?

  products Product[]
  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("categories")
}

// ============================================
// INVENTORY (Physical Stock Control)
// ============================================

model InventoryItem {
  id             String    @id @default(cuid())
  sku            String    @unique
  name           String
  category       String?
  description    String?
  brand          String?
  quantity       Int       @default(0)
  unit           String    @default("un")
  minStock       Int?
  location       String?
  costPrice      Decimal   @default(0.00)
  salePrice      Decimal   @default(0.00)
  entryDate      DateTime  @default(now())
  lastUpdated    DateTime  @updatedAt
  expirationDate DateTime?
  supplier       String?
  barcode        String?
  notes          String?
  tags           String[]
  storeId        String?
  status         Status    @default(ACTIVE)
  weight         Decimal?
  length         Decimal?
  width          Decimal?
  height         Decimal?
  color          String?
  size           String?
  model          String?

  store Store? @relation(fields: [storeId], references: [id], onDelete: SetNull)

  @@map("inventory_items")
}

// ============================================
// PAGES & BLOG
// ============================================

model Page {
  id              String   @id @default(uuid())
  storeId         String
  title           String
  slug            String   @unique
  pageType        PageType
  content         String?  @db.Text
  isActive        Boolean  @default(true)
  order           Int?
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  store     Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  blogPosts BlogPost[]

  @@index([storeId])
  @@index([slug])
  @@index([pageType])
  @@map("pages")
}

model BlogPost {
  id          String     @id @default(uuid())
  pageId      String
  storeId     String
  title       String
  slug        String     @unique
  content     String     @db.Text
  excerpt     String?
  coverImage  String?
  authorId    String
  categoryId  String?
  tags        String[]
  status      PostStatus @default(DRAFT)
  publishedAt DateTime?
  viewCount   Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  page     Page          @relation(fields: [pageId], references: [id], onDelete: Cascade)
  store    Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  author   User          @relation(fields: [authorId], references: [id])
  category BlogCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([pageId])
  @@index([storeId])
  @@index([authorId])
  @@index([categoryId])
  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@map("blog_posts")
}

model BlogCategory {
  id          String   @id @default(uuid())
  storeId     String
  name        String
  slug        String   @unique
  description String?
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  store Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  posts BlogPost[]

  @@index([storeId])
  @@index([slug])
  @@map("blog_categories")
}

// ============================================
// LINKTREE
// ============================================

model Linktree {
  id              String   @id @default(uuid())
  storeId         String
  title           String
  description     String
  backgroundColor String?
  textColor       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  links Link[]
  store Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("linktrees")
}

model Link {
  id         String   @id @default(uuid())
  url        String
  linkType   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  linktreeId String?

  linktree Linktree? @relation(fields: [linktreeId], references: [id], onDelete: Cascade)

  @@map("links")
}
